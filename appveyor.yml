version: '{build}'
image:
   - Visual Studio 2019
   - Ubuntu

environment:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  APPVEYOR_YML_DISABLE_PS_LINUX: false
  BUILD_SUFFIX: ""
  VERSION_SUFFIX: ""

configuration: Release

pull_requests:
  do_not_increment_build_number: true
  
nuget:
  disable_publish_on_pr: true

branches:
  only:
    - master
    - /\d\.\d\.\d/

init:
  # Good practise, because Windows line endings are different from Unix/Linux ones
  - ps: git config --global core.autocrlf true

  - ps: $branch =  $env:APPVEYOR_REPO_BRANCH;
  - ps: $revision = @{ $true = ""; $false = "{0:00000}" -f [convert]::ToInt32("0" + $env:APPVEYOR_BUILD_NUMBER, 10) }[$env:APPVEYOR_REPO_TAG -eq "true"];
  - ps: $suffix = @{ $true = ""; $false = "$($branch.Substring(0, [math]::Min(10,$branch.Length)))-$revision"}[$branch -eq "master" -and $revision -eq ""];
  - ps: $commitHash = $($env:APPVEYOR_REPO_COMMIT.substring(0,7));
  - ps: $env:BUILD_SUFFIX = @{ $true = "$($suffix)-$($commitHash)"; $false = "$($branch)-$($commitHash)" }[$suffix -ne ""];
  - ps: $env:VERSION_SUFFIX = @{ $true = "--version-suffix=$($suffix)"; $false = ""}[$suffix -ne ""];

install:
  - ps: dotnet restore redmine-net-api.sln
      
before_build:
  - ps: write-host "Build Suffix=$env:BUILD_SUFFIX" -foregroundcolor Green  
  - ps: write-host "Version suffix=$env:VERSION_SUFFIX" -foregroundcolor Magenta 
  - ps: dotnet --version

build_script:
  - ps: dotnet build redmine-net-api.sln -c Release --version-suffix=$env:BUILD_SUFFIX
    
after_build:
  - ps: echo "Build suffix= $env:BUILD_SUFFIX"
  - ps: echo "Version suffix= $env:VERSION_SUFFIX"
  - ps: dotnet pack src\redmine-net-api\redmine-net-api.csproj -c Release --output .\artifacts --include-symbols --no-build $env:VERSION_SUFFIX

test: off

artifacts:
  - name: NuGet Packages
    path: .\artifacts\**\*.nupkg
  - name: NuGet Symbol Packages
    path: .\artifacts\**\*.snupkg
    
skip_commits:
  files:
    - '**/*.md'
    - '**/*.gif'
    - '**/*.png'
    - '**/*.yml'
    - LICENSE
    - tests/*

for:
  -
    matrix:
      only:
        - image: Ubuntu

    deploy:
      - provider: NuGet
        name: production
        api_key:
          secure: fo+5VNPIRQ98jFPBZSd4SsOVyXEsTxnQ52VWTrg3sgH1GwGXhi70Q561eimlmRhy
        skip_symbols: true
        on:
          branch: master
          APPVEYOR_REPO_TAG: true 